# The Structural Safety Generalization Problem

This repository contains code and data for "The Structural Safety Generalization Problem"

## Code and Resources

The primary entry point is the `inferencing.py` script. You can run it from the command line with various options. For example:

```bash
python inferencing.py \
  --data_file path/to/your/dataset.json \
  --output_dir outputs/experiment1 \
  --model_name "gpt-4o-mini" \
  --api_key your_api_key_here \
  --runs 3 \
  --methods "Perturbed Decomposition" \
  --use_guardrail \
  --strongreject \
  --strongreject_model "gpt-4o" \
  --strongreject_prompt path/to/custom_strongreject_prompt.txt
```

### Command-Line Options

- **--data_file**: Path to the JSON dataset.
- **--output_dir**: Directory where JSON and CSV results will be saved.
- **--model_name**: The name of the model to use (any model supported by your LLM wrapper).
- **--api_key**: API key (if not provided, the script will look for `LLM_API_KEY` in the environment).
- **--use_guardrail**: Wraps the base LLM in a guardrail (for prompt canonicalization and refusal detection).
- **--strongreject**: After generating responses, run strongreject evaluation to produce scores and reasonings.
- **--strongreject_model**: Which model to use for strongreject evaluation.
- **--strongreject_prompt**: Path to a custom strongreject evaluator prompt.
- **--methods**: A list of method names (as defined in the datasetâ€™s "Type" field) to process. If omitted, the script processes all entries.
- **--runs**: Number of responses (runs) to generate per entry.

### Output Files

Results are saved in both JSON and CSV formats with filenames in the format:
```
{model_name}-{timestamp}.json
{model_name}-{timestamp}.csv
```

## Datasets

### Multi-Turn Datasets

1. **Harmful Dataset**  
   - **Total Size**: 24,816 examples  
   - **Source**: 4,136 unique harmful instructions from AdvBench, augmented with priming to produce a range of malicious requests.  
   - **Language Settings**: Cipher, Welsh, Tamil  
   - **Structure Variations**: Single-Turn vs. Multi-Turn  

2. **Benign Dataset**  
   - **Partially Benign**: 1,200 user instructions that are non-harmful but contain toxic words.  
   - **Completely Benign**: 1,200 user instructions with no harmful or toxic content.  

### Multi-Modal Datasets

1. **Harmful Dataset**  
   - **Total Size**: 6,500 examples  
   - **Base Instructions**: 500 unique harmful instructions generated by GPT-4o and Dolphin Mixtral across 5 categories (Harmful Content, Malicious Activities, Dangerous Substances, Misinformation, Explicit Content).  
   - **Language Settings**: English, Welsh, Tamil  
   - **Structure Variations**:  
     - Plain text vs. unperturbed & perturbed variants vs. composite & decomposite variants vs. color substitution cipher
     - Welsh and Tamil only include plain text and unperturbed variants

2. **Benign Dataset**  
   - **Total Size**: 90 unique benign instructions  
   - **Structure Variations**:  
     - Decomposed Color Substitution Cipher & Perturbed Decomposed Images

### Organization and Access

1. **Multi-Turn** data is stored primarily under `datasets/[benign|harmful]/multiturn/`.
2. **Multi-Modal** data is stored primarily under `datasets/[benign|harmful]/multimodal/`.
3. Each dataset folder may contain a `dataset.json` file, which'll reference image paths (if applicable) and relevant fields:
   - **ID**  
   - **Type**
   - **Prompt** (text, sometimes referencing images)  
   - **Full Phrase** (the instruction itself as English text)
   - **Category**
   - **Subcategory**  
   - **Images** (paths to PNG files)
